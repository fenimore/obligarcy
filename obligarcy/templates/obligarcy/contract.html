{% extends "obligarcy/base.html" %}

{% block content %}
<div class='row'>
  <div class='col-md-6'>
    <h4>{{ contract.title }}</h4>
    <p>{{ contract.conditions }}</p>
    <p><small>
    {{ contract.small_print }}</small></p><br><br>

    {% for signee in contract.users.all() %}
    Signee: <a href="/user/{{ signee.id }}/">{{signee.username}}</a><br>
    {% endfor %}
    <br>Contract starts: {{ contract.start_date.strftime('%D - %H:%M') }}<br>
        Contract ends: {{ contract.end_date.strftime('%D - %H:%M') }}<br>
<table class="table table-hover">
    <tr>
      <th>Deadlines:</th>
      {% for u in contract.users.all() %}
        <th>{{ u.username }}
        </th>
      {% endfor %}
    </tr>
    {% for dl in deadlines %}
    <tr>
      <td>
        {{ dl.deadline.date().strftime('%D') }}
        {% if dl.is_expired %}
        Expired
        {% endif %}
      </td>
      {% for u in contract.users.all() %}
        <td>
            {% if not u.deadline_set.filter(contract=contract, deadline=dl.deadline).first().is_accomplished %}
              {% if u.deadline_set.filter(contract=contract, deadline=dl.deadline).first().is_expired %}
              <span class="glyphicon glyphicon-remove-circle" aria-hidden="true" style="color:red">
              </span>
              {% else %}
              <span class="glyphicon glyphicon-record" aria-hidden="true" style="color:grey">
              </span>
              {% endif %}
            {% else %}
              {% if u.deadline_set.filter(contract=contract, deadline=dl.deadline).first().is_late %}
              <a href="/submission/{{ u.deadline_set.filter(contract=contract, deadline=dl.deadline).first().submission.id }}/">
                <span class="glyphicon glyphicon-ok-circle" aria-hidden="true" style="color:blue">
                </span></a><br>
              {% else %}
              <a href="/submission/{{ u.deadline_set.filter(contract=contract, deadline=dl.deadline).first().submission.id }}/">
                <span class="glyphicon glyphicon-ok-circle" aria-hidden="true" style="color:green">
                </span></a>
              {% endif %}
            {% endif %}

            {{ u.deadline_set.filter(contract=contract, deadline=dl.deadline).first().deadline.strftime('%D - %H:%M') }}
          </td>
      {% endfor %}
    </tr>
    {% endfor %}

</table>
  </div>
  <div class='col-md-4'>
    <div class="panel panel-default">
      <div class="panel-body">
        <small>Remaining Deadlines</small><br>
        <div id='deadline_list'>
        {% for deadline in contract.deadline_set.filter(is_accomplished=False, is_expired=False).order_by('deadline') %}

        {{deadline.deadline.strftime('%d-%m %H:%M')}} {{deadline.signee}}<br>

        {% endfor %}<br>
        </div>

        {% if user.is_authenticated %}<br>
          {% if user in contract.users.all() %}<br>
            <a class='btn btn-default' href=/submit/{{ contract.id }}/{{user.id}}>Submit a text</a>
          {% else %}
            {% if allow_signing %}
              <a class='btn btn-info' href=/sign/{{ contract.id }}>Sign Contract</a>
            {% endif %}<br>
          {% endif %}<br>
        {% endif %}<br>
        Active Contract: {{ contract.is_active}}<br>
        Completed By:
        <hr>

            <h4>Submissions</h4>
            {% if contract.submissions.all() %}
                <ul>
                {% for submission in contract.submissions.all() %}
                    <li><a href="/user/{{ submission.user.id }}/">{{ submission.user }}</a>{{submission.body[:50]}}...<br> <a href="/submission/{{ submission.id }}">@ {{ submission.pub_date.strftime('%d-%m %H:%M') }}</a></li>
                    <b>for</b> {{ submission.deadline_set.all().first() }}
                    <hr>
                {% endfor %}
                </ul>
            {% else %}
                <p>This Contract has no submissions</p>
            {% endif %}

    </div>


  </div>
</div>
<br><br>
        {% endblock content %}

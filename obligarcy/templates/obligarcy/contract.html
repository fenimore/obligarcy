{% extends "obligarcy/base.html" %}

{% block content %}
<div class='row'>
  <div class='col-md-6'>
    <h4>{{ contract.preamble }}</h4><br>
    {{ contract.conditions }}<br>
    {{ contract.penalties }}<br><br>

    {% for signee in contract.users.all() %}
    Signee: <a href="/user/{{ signee.id }}/">{{signee.username}}</a><br>
    {% endfor %}

<br>Contract ends: {{ contract.end_date }}<br>
<hr>
<h4>Deadlines</h4>
<table class="table table-hover">
    <tr>
      <th>Deadlines:</th>
      {% for u in contract.users.all() %}
        <th>{{ u.username }}
        </th>
      {% endfor %}
    <tr>
    {% for dl in contract.users.all().first().deadline_set.filter(contract=contract) %}
    <tr>
      <td>
        {{ dl.deadline.date() }}
        {% if dl.is_expired %}
        Expired
        {% endif %}
      </td>
      {% for u in contract.users.all() %}
        <td>{{ u.deadline_set.filter(contract=contract, deadline=dl.deadline).first() }}
            {% if not u.deadline_set.filter(contract=contract, deadline=dl.deadline).first().is_accomplished %}
              not submitted
            {% else %}
            <a href="/submission/{{ u.deadline_set.filter(contract=contract, deadline=dl.deadline).first().submission.id }}/">
              <span class="glyphicon glyphicon-circle-ok" aria-hidden="true" style="color:green">
              </span></a><br>
            {% endif %}
          </td>
      {% endfor %}
    </tr>
    {% endfor %}

</table>
  </div>
  <div class='col-md-4'>
    <div class="panel panel-default">
      <div class="panel-body">
        <small>Frequency: {{ contract.frequency }}</small><br>
        <div id='deadline_list'>
        {% for deadline in contract.deadline_set.filter(is_accomplished=False) %}

        {{deadline.deadline}}, {{deadline.signee}}<br>

        {% endfor %}<br>
        </div>

        {% if user.is_authenticated %}<br>
          {% if user in contract.users.all() %}<br>
            <a class='btn btn-default' href=/submit/{{ contract.id }}/{{user.id}}>Submit a text</a>
          {% else %}
            {% if allow_signing %}
              <a class='btn btn-info' href=/sign/{{ contract.id }}>Sign Contract</a>
            {% endif %}<br>
          {% endif %}<br>
        {% endif %}<br>

        <hr>

            <h4>Submissions</h4>
            {% if contract.submissions.all() %}
                <ul>
                {% for submission in contract.submissions.all() %}
                    <li><a href="/user/{{ submission.user.id }}/">{{ submission.user }}</a> <a href="/submission/{{ submission.id }}">@ {{ submission.pub_date }}</a></li>
                    <b>for</b> {{ submission.deadline_set.all().first() }}
                    <hr>
                {% endfor %}
                </ul>
            {% else %}
                <p>This Contract has no submissions</p>
            {% endif %}

    </div>


  </div>
</div>
<br><br>
        {% endblock content %}
